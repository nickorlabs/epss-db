import os
import psycopg2

PG_CONFIG = {
    'host': os.environ.get('PGHOST', 'db'),
    'user': os.environ.get('PGUSER', 'postgres'),
    'password': os.environ.get('PGPASSWORD', 'postgres'),
    'dbname': os.environ.get('PGDATABASE', 'epssdb'),
}

TAGS_CSV = 'exploit_tags.csv'  # Now reads from project directory

def import_tags():
    print("Importing exploit tags into PostgreSQL with COPY ...")
    conn = None
    try:
        conn = psycopg2.connect(**PG_CONFIG)
        conn.autocommit = True
        cursor = conn.cursor()
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS exploit_tags (
            exploit_id TEXT,
            tag TEXT
        );
        """)
        with open(TAGS_CSV, 'r', encoding='utf-8') as f:
            cursor.copy_expert(
                "COPY exploit_tags (exploit_id, tag) FROM STDIN WITH CSV HEADER",
                f
            )
        print("Imported exploit tags into PostgreSQL via COPY.")
    except Exception as e:
        print(f"PostgreSQL Error: {e}")
        exit(1)
    finally:
        if conn:
            cursor.close()
            conn.close()

if __name__ == "__main__":
    import_tags()
