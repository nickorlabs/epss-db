#!/bin/bash

# exploit-init.sh - Initialize exploit database tables
# Using dynamic path detection for portability
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
BASEPATH="$(dirname "$SCRIPT_DIR")"
MYSQL_CONFIG="$BASEPATH/my.cnf"

echo "=== Initializing Exploit Database ==="
echo "Using base path: $BASEPATH"

# Check if MySQL config exists
if [ ! -f "$MYSQL_CONFIG" ]; then
  echo "Error: MySQL configuration not found at $MYSQL_CONFIG"
  exit 1
fi

# Create exploits table
echo "Creating exploits table..."
mysql --defaults-file="$MYSQL_CONFIG" -D epssdb -e "
CREATE TABLE IF NOT EXISTS exploits (
    id INT AUTO_INCREMENT PRIMARY KEY,
    cve_id VARCHAR(20) NOT NULL,
    source VARCHAR(50) NOT NULL,
    source_id VARCHAR(100) NOT NULL,
    url TEXT,
    title VARCHAR(255),
    description TEXT,
    date_published DATE,
    technique VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY unique_exploit (cve_id, source, source_id)
);"

# Create exploit_metadata table
echo "Creating exploit_metadata table..."
mysql --defaults-file="$MYSQL_CONFIG" -D epssdb -e "
CREATE TABLE IF NOT EXISTS exploit_metadata (
    exploit_id INT NOT NULL,
    meta_key VARCHAR(100) NOT NULL,
    meta_value TEXT,
    PRIMARY KEY (exploit_id, meta_key),
    FOREIGN KEY (exploit_id) REFERENCES exploits(id) ON DELETE CASCADE
);"

# Create exploit_tags table
echo "Creating exploit_tags table..."
mysql --defaults-file="$MYSQL_CONFIG" -D epssdb -e "
CREATE TABLE IF NOT EXISTS exploit_tags (
    exploit_id INT NOT NULL,
    tag VARCHAR(100) NOT NULL,
    PRIMARY KEY (exploit_id, tag),
    FOREIGN KEY (exploit_id) REFERENCES exploits(id) ON DELETE CASCADE
);"

# Create indexes for better query performance
echo "Creating indices..."
mysql --defaults-file="$MYSQL_CONFIG" -D epssdb -e "
CREATE INDEX idx_exploits_cve_id ON exploits(cve_id);
CREATE INDEX idx_exploits_source ON exploits(source);
CREATE INDEX idx_exploits_date ON exploits(date_published);
CREATE INDEX idx_exploit_tags_tag ON exploit_tags(tag);
"

echo "=== Exploit Database Initialization Complete ==="
